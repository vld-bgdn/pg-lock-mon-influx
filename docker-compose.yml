version: "3"
services:
  grafana:
    hostname: grafana1
    image: grafana/grafana-oss
    ports:
      - "3000:3000"
    environment:
      - INFLUX_URI=http://influxdb1:8086
      - INFLUX_DB=check-db
      - INFLUX_USER=admin
      - INFLUX_PASSWORD=admin_pass
      - INFLUX_TOKEN=check-token
      - INFLUX_ORG=check-org
      - INFLUX_BUCKET=check-bucket
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
  postgres:
    hostname: postgres1
    image: postgres
    environment:
      POSTGRES_PASSWORD: postgres_pass
      TELEGRAF_PASSWORD: telegraf_password
      APP_PASSWORD: app_password
    volumes:
      - ./postgres/setup_db.sh:/docker-entrypoint-initdb.d/setup_db.sh
  influxdb:
    hostname: influxdb1
    image: influxdb
    ports:
      - 8086:8086
    depends_on:
      - postgres
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin_pass
      - DOCKER_INFLUXDB_INIT_ORG=check-org
      - DOCKER_INFLUXDB_INIT_BUCKET=check-bucket
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=check-token
      - DB_NAME=check-db
      - RP_NAME=check-rp
    volumes:
      - ./influxdb/setup-v1.sh:/docker-entrypoint-initdb.d/setup-v1.sh
  telegraf:
    hostname: telegraf1
    image: telegraf
    depends_on:
      - influxdb
    environment:
      - INFLUX_HOST=influxdb1
      - INFLUX_ADMIN_TOKEN=check-token
      - INFLUX_ORG=check-org
      - INFLUX_BUCKET=check-bucket
      - POSTGRES_URI=postgres://telegraf:telegraf_password@postgres1/postgres?sslmode=disable
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf
  app:
    hostname: app1
    image: app
    build:
      context: ./app
      dockerfile: ./Dockerfile
    restart: always
    depends_on:
      - postgres
      - telegraf
      - influxdb
      - grafana
    environment:
      - POSTGRES_URI=postgresql+psycopg2://app:app_password@postgres1/testlockdb?sslmode=disable